<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>LIZY - Comparateur</title>
  <link rel="icon" href="https://s3-eu-west-1.amazonaws.com/tpd/logos/652d2eaf70beb7b68772d519/0x0.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
   body {
      font-family: 'Nunito', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #FF007A, #FF5E3A);
      color: #fff;
    }

    header {
      background: transparent;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    header img {
      height: 50px;
      margin-right: 10px;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    button {
      background: #fff;
      color: #FF007A;
      font-weight: bold;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      margin: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #ffe3f0;
    }

    input[type="file"] {
      margin: 10px;
    }

    #diffModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.85);
      z-index: 999;
      justify-content: center;
      align-items: center;
    }

    #modalContent {
      background: #fff;
      color: #000;
      padding: 30px;
      border-radius: 15px;
      width: 80%;
      max-width: 600px;
      text-align: center;
      touch-action: pan-y;
    }

    .cellContent {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 15px;
    }

    .originalText {
      background: #f4f4f4;
      color: #333;
    }

    .modifiedText {
      background: #e0ffe0;
      color: #333;
    }

  <script>
    let differences = [];
    let currentIndex = 0;
    let originalRows = [];
    let modifiedRows = [];
    let mergedRows = [];

    function parseCSV(text) {
  const rows = [];
  let current = [];
  let cell = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const char = text[i];
    const nextChar = text[i + 1];

    if (char === '"' && inQuotes && nextChar === '"') {
      cell += '"';
      i++; // skip escaped quote
    } else if (char === '"') {
      inQuotes = !inQuotes;
    } else if (char === ',' && !inQuotes) {
      current.push(cell);
      cell = '';
    } else if ((char === '\n' || char === '\r') && !inQuotes) {
      if (cell || char === '\n') current.push(cell);
      if (current.length) rows.push(current);
      current = [];
      cell = '';
      if (char === '\r' && nextChar === '\n') i++; // Windows-style newline
    } else {
      cell += char;
    }
  }

  if (cell || current.length) {
    current.push(cell);
    rows.push(current);
  }

  return rows;
}


    async function compareCSVs() {
      const origFile = document.getElementById('originalCSV').files[0];
      const modFile = document.getElementById('modifiedCSV').files[0];
      const status = document.getElementById('status');

      if (!origFile || !modFile) {
        status.textContent = '‚ùå Veuillez importer les deux fichiers CSV.';
        return;
      }

      status.textContent = '‚è≥ Lecture des fichiers...';

      const origText = await origFile.text();
      const modText = await modFile.text();

      originalRows = parseCSV(origText);
      modifiedRows = parseCSV(modText);

      const maxRows = Math.max(originalRows.length, modifiedRows.length);
      const maxCols = Math.max(...originalRows.map(r => r.length));

      mergedRows = JSON.parse(JSON.stringify(originalRows));
      differences = [];

      for (let i = 0; i < maxRows; i++) {
        for (let j = 0; j < maxCols; j++) {
          const origCell = originalRows[i]?.[j] || '';
          const modCell = modifiedRows[i]?.[j] || '';
          if (origCell !== modCell) {
            differences.push({ i, j, orig: origCell, mod: modCell });
          }
        }
      }

      if (differences.length === 0) {
        status.textContent = '‚úÖ Aucune diff√©rence trouv√©e !';
        return;
      }

      status.textContent = `üîç ${differences.length} diff√©rences trouv√©es.`;
      currentIndex = 0;
      showNextDiff();
    }

    function showNextDiff() {
      if (currentIndex >= differences.length) {
        document.getElementById('diffModal').style.display = 'none';
        generateMergedCSV();
        return;
      }

      const { orig, mod } = differences[currentIndex];
      document.getElementById('originalDisplay').innerHTML = `<strong>Original :</strong><br>${formatText(orig)}`;
      document.getElementById('modifiedDisplay').innerHTML = `<strong>Modifi√© :</strong><br>${formatText(mod)}`;
      document.getElementById('diffModal').style.display = 'flex';
    }

    function validateChange(accepted) {
      const { i, j, orig, mod } = differences[currentIndex];
      mergedRows[i][j] = accepted ? mod : orig;
      currentIndex++;
      showNextDiff();
    }

    function formatText(text) {
      return text.replace(/<a /gi, '<a style="color:#FF007A;font-weight:bold;" ');
    }

    function generateMergedCSV() {
      const csv = mergedRows.map(r => r.join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'csv_fusionne.csv';
      link.textContent = 'üì• T√©l√©charger le CSV fusionn√©';
      link.style = 'display:block;margin-top:20px;color:#fff;font-weight:bold;';
      document.querySelector('main').appendChild(link);
    }

    let startX = null;
    const modal = document.getElementById('modalContent');

    modal.addEventListener('touchstart', e => {
      startX = e.touches[0].clientX;
    });

    modal.addEventListener('touchend', e => {
      if (startX === null) return;
      const endX = e.changedTouches[0].clientX;
      const deltaX = endX - startX;

      if (Math.abs(deltaX) > 50) {
        validateChange(deltaX > 0); // droite = accepter, gauche = refuser
      }
      startX = null;
    });
  </script>
</body>
</html>
