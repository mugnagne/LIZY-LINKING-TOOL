<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>LIZY Auto-Linker 1.1</title>
  <link rel="icon" href="https://s3-eu-west-1.amazonaws.com/tpd/logos/652d2eaf70beb7b68772d519/0x0.png" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Nunito', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #FF007A, #FF5E3A);
      color: #fff;
    }

    header {
      background: transparent;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    header img {
      height: 50px;
      margin-right: 10px;
    }

    main {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px 20px;
    }

    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }

    .container {
      display: flex;
      flex-direction: row;
      gap: 20px;
      width: 100%;
      max-width: 1200px;
      flex-wrap: wrap;
    }

    textarea {
      flex: 1;
      height: 400px;
      padding: 15px;
      border-radius: 10px;
      border: none;
      font-size: 16px;
      resize: vertical;
    }

    #inputText {
      background: #fff;
      color: #333;
    }

    #previewArea {
      white-space: pre-wrap;
      flex: 1;
      background: #fff;
      color: #000;
      padding: 15px;
      border-radius: 10px;
      height: 400px;
      overflow-y: auto;
    }

    #statsPanel {
  max-width: 320px;
  background: #fff;
  color: #000;
  border-radius: 10px;
  padding: 20px;
  font-size: 15px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

    #statsPanel h2 {
  margin-top: 0;
  font-size: 18px;
  color: #FF007A;
  display: flex;
  align-items: center;
  gap: 6px;
}

    button {
      background: #fff;
      color: #FF007A;
      font-weight: bold;
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      margin: 20px 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }

    button:hover {
      background: #ffe3f0;
    }

    .form-section {
      margin-top: 40px;
      background: #fff;
      color: #000;
      padding: 20px;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
    }

    .form-section h2 {
      margin-top: 0;
    }

    .form-section input,
    .form-section select {
      width: 80%;
      padding: 8px;
      margin: 10px auto;
      display: block;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .link-manager {
      background: #fff;
      color: #000;
      max-width: 600px;
      width: 100%;
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
    }

    .link-manager h2 {
      margin-top: 0;
    }

    .link-manager table {
      width: 100%;
      border-collapse: collapse;
    }

    .link-manager th, .link-manager td {
      text-align: left;
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }

    .link-manager button {
      margin: 0;
      font-size: 12px;
      padding: 4px 8px;
    }
  </style>
</head>
<body>
  <header>
    <img src="https://s3-eu-west-1.amazonaws.com/tpd/logos/652d2eaf70beb7b68772d519/0x0.png" alt="Logo LIZY">
    <h1>LIZY Auto-Linker 1.3</h1>
  </header>

  <main>
    <div class="container">
  <textarea id="inputText" placeholder="Paste your text here"></textarea>
<div id="previewArea"></div>
<div id="statsPanel">
    <h2>üìä Statistiques du texte</h2>
    <p><strong>üîó Number of links:</strong> <span id="totalLinks">0</span></p>
    <p><strong>üìà Link %:</strong> <span id="enrichedPercent">0%</span></p>
    <p><strong>‚ôªÔ∏è Duplicate links:</strong> <span id="duplicateLinks">0</span></p>
    <p><strong>üìÇ Category repartition:</strong></p>
    <ul>
      <li>üìù Articles: <span id="cat1">0</span></li>
      <li>üöó Models: <span id="cat2">0</span></li>
      <li>üè∑Ô∏è Brands: <span id="cat3">0</span></li>
    </ul>
  </div>
  </div>
    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; align-items: center; margin-top: 20px;">
  <button onclick="convertText()">Ajouter les liens</button>
  <button onclick="toggleLinkManager()">Afficher / Masquer les liens ajout√©s</button>
  <button onclick="copyHTML()">üìã Copier le HTML enrichi</button>
  <button onclick="enrichCSVWithGPT()">‚ú® Enrichir CSV avec GPT</button>
 
  <span id="copyFeedback" style="color: green; font-weight: bold; opacity: 0; transition: opacity 0.5s;"></span>
</div>
    <div style="margin-top: 10px; text-align: center;">
  
</div>


    <div class="form-section">
      <h2>Add a new keyword</h2>
      <input type="text" id="customWord" placeholder="Keyword (ex: Tesla Model Y)">
      <input type="text" id="customURL" placeholder="URL (ex: https://en.wikipedia.org/wiki/Tesla_Model_Y)">
      <select id="customPriority">
        <option value="0">Articles</option>
        <option value="1">Models</option>
        <option value="2">Brands</option>
      </select>
      <button onclick="addCustomLink()">Add</button>
    </div>
    <div id="feedback" style="text-align:center; font-weight:bold; color:green; margin-top:10px;"></div>

<div class="link-manager" id="linkManager" style="display: none">
      <h2>Custom Links</h2>
      <div id="linkList"></div>
    </div>
      <div class="form-section">
      <h2>Upload CSV</h2>
      <button onclick="document.getElementById('csvFile').click()">Upload a CSV file</button>
      <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
      <div id="csvStatus" style="margin-top: 10px; font-weight: bold;"></div>
    
      <button onclick="enrichCSVArticleColumn()">Enrich Text</button>
    </div>
  </main>

  <script>
    let originalCSVRows = null;
let enrichedCSVRows = null;
let articleColumnIndex = null;
    function escapeRegExp(string) {
      return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }
    
   function updateStats(text, linkCountMap, totalText, priorityCounts) {
      const totalLinks = Object.values(linkCountMap).reduce((a, b) => a + b, 0);
      const uniqueLinks = Object.keys(linkCountMap).length;
      const duplicates = totalLinks - uniqueLinks;

      const totalWords = totalText.trim().split(/\s+/).length;
      const enrichedWords = totalLinks; // totalLinks = nombre de mots li√©s
      const linkPercentage = ((enrichedWords / totalWords) * 100).toFixed(1);

      document.getElementById("totalLinks").textContent = totalLinks;
      document.getElementById("duplicateLinks").textContent = duplicates;
      document.getElementById("enrichedPercent").textContent = `${linkPercentage}%`;

      document.getElementById("cat1").textContent = priorityCounts[0];
      document.getElementById("cat2").textContent = priorityCounts[1];
      document.getElementById("cat3").textContent = priorityCounts[2];
    }

    function getSavedLinks() {
      const saved = localStorage.getItem("lizyLinks");
      return saved ? JSON.parse(saved) : [{}, {}, {}];
    }

    function saveLinks(links) {
      localStorage.setItem("lizyLinks", JSON.stringify(links));
    }

    function convertText() {
  const defaultLinks = [
    {
      "Tesla Model 3": "https://fr.wikipedia.org/wiki/Tesla_Model_3"
    },
    {
      "Chine": "https://fr.wikipedia.org/wiki/Chine"
    },
    {
      "Tesla": "https://fr.wikipedia.org/wiki/Tesla,_Inc.",
      "BMW": "https://fr.wikipedia.org/wiki/BMW",
      "Volkswagen": "https://fr.wikipedia.org/wiki/Volkswagen"
    }
  ];

  const customLinks = getSavedLinks();
  const priorityLinks = defaultLinks.map((group, i) => ({ ...group, ...customLinks[i] }));

  let originalText = document.getElementById("inputText").value;
  let text = originalText;
  const placeholders = [];
  let index = 0;
  const linkCountMap = {};
  const priorityCounts = [0, 0, 0];

  for (let i = 0; i < priorityLinks.length; i++) {
    const level = priorityLinks[i];
    for (const word in level) {
      const url = level[word];
      const escaped = escapeRegExp(word);
      const regex = new RegExp(escaped, 'gi');
      text = text.replace(regex, match => {
        const placeholder = `@@@${index}@@@`;
        placeholders.push({
          placeholder,
          html: `<a href="${url}" target="_blank" style="color: #FF007A; text-decoration: underline;">${match}</a>`
        });
        linkCountMap[url] = (linkCountMap[url] || 0) + 1;
        priorityCounts[i]++;
        index++;
        return placeholder;
      });
    }
  }

  for (const item of placeholders) {
    text = text.replace(item.placeholder, item.html);
  }

  document.getElementById("previewArea").innerHTML = text;

  // ‚úÖ D√©place l'appel ici √† la toute fin
  updateStats(text, linkCountMap, originalText, priorityCounts);
}

    function addCustomLink() {
      const word = document.getElementById("customWord").value.trim();
      let url = document.getElementById("customURL").value.trim();
      const priority = parseInt(document.getElementById("customPriority").value);

      if (!word || !url) {
        alert("Merci de remplir tous les champs.");
        return;
      }

      if (!/^https?:\/\//i.test(url)) {
        url = "https://" + url;
      }

      const savedLinks = getSavedLinks();
      savedLinks[priority][word] = url;
      saveLinks(savedLinks);

      document.getElementById("feedback").textContent = `‚úÖ Keyword "${word}" added!`;
setTimeout(() => document.getElementById("feedback").textContent = '', 3000);
      document.getElementById("customWord").value = "";
      document.getElementById("customURL").value = "";
      document.getElementById("customPriority").value = "0";

      renderLinkList();
    } 

    function deleteCustomLink(priority, word) {
      const savedLinks = getSavedLinks();
      delete savedLinks[priority][word];
      saveLinks(savedLinks);
      renderLinkList();
    }

    function renderLinkList() {
      const savedLinks = getSavedLinks();
      const listDiv = document.getElementById("linkList");
      listDiv.innerHTML = "";

      savedLinks.forEach((group, index) => {
        const groupTitle = document.createElement("h3");
        groupTitle.textContent = `Priorit√© ${index + 1}`;
        listDiv.appendChild(groupTitle);

        const table = document.createElement("table");
        const thead = document.createElement("thead");
        thead.innerHTML = "<tr><th>Mot-cl√©</th><th>URL</th><th></th></tr>";
        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        for (const word in group) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${word}</td>
            <td><a href="${group[word]}" target="_blank">${group[word]}</a></td>
            <td><button onclick="deleteCustomLink(${index}, '${word.replace(/'/g, "\\'")}')">Supprimer</button></td>
          `;
          tbody.appendChild(row);
        }
        table.appendChild(tbody);
        listDiv.appendChild(table);
      });
    }

    function toggleLinkManager() {
      const section = document.getElementById("linkManager");
      section.style.display = section.style.display === "none" ? "block" : "none";
      if (section.style.display === "block") {
        renderLinkList();
      }
    }
  function handleCSVUpload(event) {
  const file = event.target.files[0];
  if (file) {
    document.getElementById("csvStatus").textContent = `‚úîÔ∏è ${file.name} uploaded successfully.`;
    document.getElementById("csvStatus").style.color = "green";
  } else {
    document.getElementById("csvStatus").textContent = "‚ùå No file selected.";
    document.getElementById("csvStatus").style.color = "red";
  }
}
function enrichCSVArticleColumn() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  if (!file) {
    alert("‚ùå Please upload a CSV file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {
    const text = e.target.result;
    const rows = text.split('\n').map(r => r.split(','));
    const headers = rows[0];
    const articleIndex = headers.findIndex(h => h.trim().toLowerCase() === 'article');

    if (articleIndex === -1) {
      alert("‚ùå No 'Article' column found in the uploaded CSV.");
      return;
    }

    // Enrichissement
    const defaultLinks = [...]; // ton tableau existant
    const customLinks = getSavedLinks();
    const priorityLinks = defaultLinks.map((group, i) => ({ ...group, ...customLinks[i] }));

    const enrichedRows = rows.map((row, i) => {
      if (i === 0) return row;
      let cell = row[articleIndex];
      if (!cell) return row;

      const placeholders = [];
      let index = 0;
      for (const level of priorityLinks) {
        for (const word in level) {
          const url = level[word];
          const regex = new RegExp(escapeRegExp(word), 'gi');
          cell = cell.replace(regex, match => {
            const placeholder = `@@@${index}@@@`;
            placeholders.push({ placeholder, html: `<a href="${url}" target="_blank">${match}</a>` });
            index++;
            return placeholder;
          });
        }
      }

      for (const item of placeholders) {
        cell = cell.replace(item.placeholder, item.html);
      }

      row[articleIndex] = cell;
      return row;
    });

    // üëâ Stockage global pour comparaison
    originalCSVRows = rows;
    enrichedCSVRows = enrichedRows;
    articleColumnIndex = articleIndex;

    // Affichage modal
    showVerificationModal(originalCSVRows, enrichedCSVRows, articleColumnIndex);

    // t√©l√©chargement
    const csvContent = enrichedRows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'enriched_articles.csv';
    downloadLink.textContent = '‚¨áÔ∏è Download enriched CSV';
    downloadLink.style = 'margin-top: 10px; display: inline-block; color: #FF007A; font-weight: bold;';
    document.getElementById('csvStatus').appendChild(downloadLink);
  };

  reader.readAsText(file);
}



function copyHTML() {
  const html = document.getElementById("previewArea").innerHTML;
  navigator.clipboard.writeText(html).then(() => {
    const feedback = document.getElementById("copyFeedback");
    feedback.textContent = "‚úÖ HTML copied to clipboard!";
    feedback.style.opacity = "1";
    setTimeout(() => {
      feedback.style.opacity = "0";
    }, 2500);
  }).catch(() => {
    const feedback = document.getElementById("copyFeedback");
    feedback.textContent = "‚ùå Failed to copy.";
    feedback.style.opacity = "1";
    setTimeout(() => {
      feedback.style.opacity = "0";
    }, 2500);
  });
}
    
async function enrichCSVWithGPT() {
  const fileInput = document.getElementById('csvFile');
  const file = fileInput.files[0];
  if (!file) {
    alert("‚ùå Please upload a CSV file first.");
    return;
  }

  const reader = new FileReader();
  reader.onload = async function (e) {
    const text = e.target.result;
    const rows = text.split('\n').map(r => r.split(','));
    const headers = rows[0];
    const articleIndex = headers.findIndex(h => h.trim().toLowerCase() === 'article');
    const idIndex = headers.findIndex(h => h.trim().toLowerCase() === 'id');
    const titleIndex = headers.findIndex(h => h.trim().toLowerCase() === 'title');

    if (articleIndex === -1) {
      alert("‚ùå No 'Article' column found in the uploaded CSV.");
      return;
    }

    const apiKey = prompt("Entrez votre cl√© API OpenAI (elle ne sera pas stock√©e)");

    const enrichedRows = [headers];
    for (let i = 1; i < rows.length; i++) {
      const row = rows[i];
      const content = row[articleIndex];
      const title = row[titleIndex] || '';
      const id = row[idIndex] || '';

      if (!content) {
        enrichedRows.push(row);
        continue;
      }

      const prompt = `Voici un article :\n\n${content}\n\n, change la colonne "article" pour y mettre des mots au hasard parmis "Minecraft, Neuille, Theotim`;

      try {
        const completion = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "gpt-4",
            messages: [{ role: "user", content: prompt }],
            temperature: 0.7
          })
        });

        const result = await completion.json();
        const enriched = result.choices?.[0]?.message?.content || content;
        row[articleIndex] = enriched;
      } catch (err) {
        alert(`Erreur sur la ligne ${i} : ${err.message}`);
      }

      enrichedRows.push(row);
    }

    const csvContent = enrichedRows.map(r => r.join(',')).join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const downloadLink = document.createElement('a');
    downloadLink.href = URL.createObjectURL(blob);
    downloadLink.download = 'enriched_articles_gpt.csv';
    downloadLink.textContent = '‚¨áÔ∏è Download enriched CSV (GPT)';
    downloadLink.style = 'margin-top: 10px; display: inline-block; color: #FF007A; font-weight: bold;';
    document.getElementById('csvStatus').appendChild(downloadLink);
  };

  reader.readAsText(file);
}
let originalCSVRows = null;
let enrichedCSVRows = null;
let articleColumnIndex = null;

function showVerificationModal(originalRows, enrichedRows, articleIndex) {
  originalCSVRows = originalRows;
  enrichedCSVRows = enrichedRows;
  articleColumnIndex = articleIndex;
  openVerificationPopup();
}

function openVerificationPopup() {
  const container = document.getElementById("comparisonContainer");
  container.innerHTML = "";

  if (!originalCSVRows || !enrichedCSVRows || articleColumnIndex === null) {
    container.innerHTML = "<p>‚ùå Aucune donn√©e √† comparer.</p>";
  } else {
    for (let i = 1; i < originalCSVRows.length; i++) {
      const original = originalCSVRows[i][articleColumnIndex] || "";
      const enriched = enrichedCSVRows[i][articleColumnIndex] || "";

      if (original.trim() !== enriched.trim()) {
        const block = document.createElement("div");
        block.style.marginBottom = "30px";
        block.innerHTML = `
          <div style="background:#f6f6f6; border-radius:8px; padding:10px; margin-bottom:10px;">
            <strong>üìù Avant :</strong><br>${escapeHTML(original)}
          </div>
          <div style="background:#e0ffe0; border-radius:8px; padding:10px;">
            <strong>‚ú® Apr√®s :</strong><br>${enriched}
          </div>
          <hr style="margin:20px 0;">
        `;
        container.appendChild(block);
      }
    }
  }

  document.getElementById("verificationModal").style.display = "flex";
}

function closeVerificationPopup() {
  document.getElementById("verificationModal").style.display = "none";
}

function escapeHTML(str) {
  return str.replace(/[&<>'"]/g, tag => ({
    '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
  }[tag]));
}

</script>
<div id="verificationModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.7); z-index:1000; justify-content:center; align-items:center;">
  <div style="background:#fff; color:#000; padding:20px; border-radius:12px; max-width:90%; max-height:80%; overflow:auto; position:relative;">
    <h2 style="margin-top:0;">Comparaison des articles</h2>
    <div id="comparisonContainer"></div>
    <button onclick="closeVerificationPopup()" style="position:absolute; top:10px; right:10px; background:red; color:#fff; border:none; border-radius:4px; padding:5px 10px;">Fermer</button>
  </div>
</div>
</body>
</html>
